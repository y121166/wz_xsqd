<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<title>车辆库存导入</title>
		<meta name="keywords" content="" />
		<meta name="description" content="" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <script src="{{ STATIC_URL }}assets/js/jquery-2.0.3.min.js"></script>
        <script src="{{ STATIC_URL }}layer/layer.js"></script>
        <script src="{{ STATIC_URL }}wzjs/xlsx.full.min.js"></script>
	</head>

	<body>
        <input  type="file" onchange="importExcel(this)" class="filter_input form-control"/>
        <textarea id="txtArea" cols=50 rows=10></textarea> 
        <script> 
            var wb;//读取完成的数据
            var rABS = true; //是否将文件读取为二进制字符串

            function importExcel(obj) {//导入

                //判定是否有文件
                if(obj.files.length==0) {
                    layer.msg("必须上传excel文件!");
                    return;
                }

                //获取文件后缀，以判定文件类型
                var suffix = obj.files[0].name.split(".")[1];
                //$('#_file_path').val(obj.files[0].name);
                if(suffix != 'xls' && suffix !='xlsx'){
                    layer.msg("只能上传 xls 或 xlsx 格式的文件!");
                    return;
                }

                //判断文件大小
                const IMPORTFILE_MAXSIZE = 10*1024;//这里可以自定义控制导入文件大小
                if(obj.files[0].size/1024 > IMPORTFILE_MAXSIZE){
                    layer.msg("文件不能超过10MB!");
                    return;
                }

                var f = obj.files[0]; // 文件内容
                var reader = new FileReader();  // 实例化FileReader对象

                //读取文件为二进制
                reader.readAsBinaryString(f);
                /*
                if(rABS) {
                    reader.readAsArrayBuffer(f);  // 读取为二进制
                } else {
                    reader.readAsBinaryString(f);  //读取为
                }*/

                //文件读取完成后的数据处理
                reader.onload = function(e) {

                    var data = e.target.result;
                    //读取为二进制
                    wb = XLSX.read(data, {
                            type: 'binary'
                    });

                    /*
                    if(rABS) {
                        wb = XLSX.read(btoa(fixdata(data)), {//手动转化
                            type: 'base64'
                        });
                    } else {
                        wb = XLSX.read(data, {
                            type: 'binary'
                        });
                    }
                    */

                    //wb.SheetNames[0]是获取Sheets中第一个Sheet的名字
                    //wb.Sheets[Sheet名]获取第一个Sheet的数据
                    var a=wb.SheetNames[0];
                    var b=wb.Sheets[a];//内容为方式2

                    data = XLSX.utils.sheet_to_json(b);//内容为方式1

                    if(!data||data==""){
                        layer.closeAll('loading');
                        layer.msg("文件为空,请选择另一个文件!");
                        return;
                    }
                    //console.log(data);
            　　　　　//在这里执行对解析后数据的处理TODO
            　　　　　　//var Compile_Result=Batch_Compile(data);
            　　　　　　//DrawTable(Compile_Result);
                };
                /*
                function fixdata(data) { //文件流转BinaryString
                    var o = "", l, w = 10240;
                    console.log(data.byteLength);
                    for( l = 0; l < data.byteLength / w; ++l)
                        o += String.fromCharCode.apply(null, new Uint8Array(data.slice(l * w, l * w + w)));
                    o += String.fromCharCode.apply(null, new Uint8Array(data.slice(l * w)));
                    return o;
                }
                */
        }
        </script>
    </body>
</html>
